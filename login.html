<!DOCTYPE html>
<html lang="de">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="../codebase/dhtmlx.js" type="text/javascript"></script>
    <link rel="STYLESHEET" type="text/css" href="../codebase/dhtmlx.css">
    <script type="text/javascript">
    function doOnFormInit() {
      parent.AvammLogin = parent.getCookie('login');
      parent.AvammServer = parent.getCookie('server');
      fLogin.hideItem("server");
      fLogin.setItemValue("server","");
      parent.LoadData('/configuration/status',function(Data){
       if ((Data)&&(Data.xmlDoc)) {
          if (Data.xmlDoc.status == 200) { // No Configuration found
            dhtmlx.message({
              type : "info",
              text: "Server muss konfiguriert werden",
              expire: 1000
            });
            parent.window.location.href = 'config/install.html';
         } else if ((Data)&&(Data.xmlDoc)&&(Data.xmlDoc.status!=0)) {
           console.log("server reachable "+Data.xmlDoc.status);
         } else {
           dhtmlx.message({
             type : "info",
             text: "kein Server erreichbar, bitte geben Sie einen Server an",
             expire: 15000
           });
           fLogin.showItem("server");
           fLogin.setItemValue("server",parent.AvammServer);
         }
       } else {
         dhtmlx.message({
           type : "info",
           text: "kein Server erreichbar, bitte geben Sie einen Server an",
           expire: 15000
         });
         fLogin.showItem("server");
         fLogin.setItemValue("server",parent.AvammServer);
       }
      },true);
      if (parent.AvammLogin) {
        fLogin.hideItem("data");
      } else {
        fLogin.hideItem("logoutdata");
      }
      fLogin.attachEvent("onButtonClick",function(buttonID){
        if(buttonID=="save"){
          if (fLogin.getItemValue("name")=="") {
                  dhtmlx.message({
                    type : "error",
  		              text: "Bitte Benutzer angeben",
		                expire: 5000
         	        });
          } else {
            parent.DoLogin(btoa(fLogin.getItemValue("name")+":"+fLogin.getItemValue("pass")),fLogin.getItemValue("server"),function(data){
              if (data) {
                if (data.xmlDoc.readyState == 4 && data.xmlDoc.status == 404) {
                  console.log('succesful login');
                  dhtmlx.message({
  	  	            text: "Login erfolgreich",
		                expire: 3000
           	      });
                  if (fLogin.getItemValue("store")==1) {
                    parent.setCookie('login',btoa(fLogin.getItemValue("name")+":"+fLogin.getItemValue("pass")));
                    parent.setCookie('server',fLogin.getItemValue("server"));
                    console.log('cookies set...');
                  }
                  fLogin.hideItem("data");
                  fLogin.showItem("logoutdata");
                  document.getElementById("realForm").submit();
                } else {
                  console.log('unsuccesful login '+data.status);
                  dhtmlx.message({
                    type : "error",
  		              text: "Login nicht erfolgreich",
		                expire: 5000
         	        });
                }
              } else {
                console.log('server not reachable');
                dhtmlx.message({
                  type : "error",
	  	            text: "Server nicht erreichbar",
		              expire: 15000
                });
              }
            });
          }
        }
        if(buttonID=="logout"){
          fLogin.hideItem("logoutdata");
          fLogin.showItem("data");
          AvammUser = "";
          AvammPasswd = "";
          console.log("logout, User cleared");
          dhtmlx.message({
            text: "Logout erfolgreich",
	          expire: 3000
          });
        }
      });
    }
    </script>
    <style>
	  iframe.submit_iframe {
	    position: absolute;
	    width: 1px;
	    height: 1px;
	    left: -100px;
	    top: -100px;
	    font-size: 1px;
	  }
    </style>
</head>
<body>
<ul class="dhtmlxForm" name="fLogin" oninit="doOnFormInit">
    <li ftype="fieldset" name="data" inputWidth="auto">Wilkommen
        <ul>
            <li ftype="input" name="server" value="http://localhost:8085">Server</li>
            <li ftype="input" name="name">Benutzername</li>
            <li ftype="password" name="pass">Passwort</li>
            <li ftype="checkbox" name="store">Login in Cookie speichern</li>
            <li ftype="button" name="save" value="Login"/>
        </ul>
    </li>
    <li ftype="fieldset" name="logoutdata" inputWidth="auto">Abmelden
        <ul>
            <li ftype="button" name="logout" value="Logout"/>
        </ul>
    </li>
</ul>
<div class="login_form">
  <form id="realForm" action="check.php" method="POST" target="submit_ifr">
  <div id="dhxForm"></div>
  </form>
</div>
<iframe border="0" frameBorder="0" name="submit_ifr" class="submit_iframe"></iframe>
</body>
